pipeline {
    agent {
        label 'master'
    }
        
    environment {
        MAVEN_OPTS = '-Xmx256m -Xms128m'
        JOB_NAME = 'IGP-Package-Job'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '5'))
        timeout(time: 10, unit: 'MINUTES')
    }
    
    stages {
        stage('Code Checkout') {
            steps {
                script {
                    echo "üì¶ Starting packaging of IGP project"
                    echo "üì• Checking out code..."
                    git 'https://github.com/MosALs/IGP-Project-may31.git'
                }
            }
        }
        
        stage('Code Packaging') {
            steps {
                script {
                    echo "üì¶ Creating WAR package from 3 classes..."
                    
                    // Create package (skip tests since they ran in previous job)
                    sh 'mvn package -DskipTests'
                    
                    echo "‚úÖ Packaging completed!"
                    echo "üìÅ Package created:"
                    sh 'ls -lh target/*.war || echo "No WAR files found"'
                    sh 'ls -lh target/*.jar || echo "No JAR files found"'
                    
                    // Show all target contents
                    sh 'ls -la target/'
                }
            }
        }
        
        stage('Package Info') {
            steps {
                script {
                    echo "üìã Creating deployment information..."
                    
                    writeFile file: 'deployment-info.txt', text: """
IGP Grad Project - Deployment Package
====================================
Build: #${BUILD_NUMBER}
Date: ${new Date()}
Classes: 3 main classes + 1 test class
Package Type: WAR (Web Application)

Deployment:
- Deploy WAR file to Tomcat or similar web server
- Access via: http://localhost:8080/ABCtechnologies

Status: READY ‚úÖ
"""
                    
                    echo "üìÑ Deployment info:"
                    sh 'cat deployment-info.txt'
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "üéâ Successfully packaged IGP project!"
                
                // Archive WAR files (since it's a web application)
                def warExists = sh(script: 'ls target/*.war >/dev/null 2>&1', returnStatus: true) == 0
                def jarExists = sh(script: 'ls target/*.jar >/dev/null 2>&1', returnStatus: true) == 0
                
                if (warExists) {
                    echo "üì¶ Found WAR files - archiving..."
                    archiveArtifacts artifacts: 'target/*.war', fingerprint: true
                } else if (jarExists) {
                    echo "üì¶ Found JAR files - archiving..."
                    archiveArtifacts artifacts: 'target/*.jar', fingerprint: true
                } else {
                    echo "‚ö†Ô∏è No WAR or JAR files found - archiving compiled classes"
                    archiveArtifacts artifacts: 'target/classes/**/*', allowEmptyArchive: true
                }
                
                archiveArtifacts artifacts: 'deployment-info.txt'
            }
        }
        failure {
            echo "‚ùå Packaging failed!"
        }
        always {
            cleanWs()
        }
    }
}